<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel | BridgeUTK Queue</title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{font-family:'Raleway',sans-serif;background:#f8f9fa}
    .queue-card{background:#fff;border-radius:8px;padding:10px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
  </style>
</head>
<body class="text-center">
  <div class="container" style="margin-top:80px;max-width:600px;">
    <h3 class="fw-bold mb-4">Moderator Queue Control</h3>

    <div id="sessionSection">
      <button id="startBtn" class="btn btn-success mb-3">Start New Session</button>
      <p id="sessionInfo" class="fw-bold text-primary"></p>
      <input id="sessionCode" class="form-control mb-3" placeholder="Or enter existing session code (e.g. BRG-AB12)">
      <button id="loadBtn" class="btn btn-primary mb-4">Load Queue</button>
    </div>

    <div id="queueList"></div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // üîß Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyB4AqUHT6oseUe-Jcseco3o9iWJcFOEWV4",
    authDomain: "nick-club-w.firebaseapp.com",
    projectId: "nick-club-w",
    storageBucket: "nick-club-w.firebasestorage.app",
    messagingSenderId: "734053046525",
    appId: "1:734053046525:web:b0baa61813874930148694"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const queueList = document.getElementById("queueList");
  const sessionInfo = document.getElementById("sessionInfo");
  let unsub = null;
  let currentSession = null;

  // Generate a session code like BRG-AB12
  function generateCode() {
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const digits = "0123456789";
    return "BRG-" +
      letters[Math.floor(Math.random() * 26)] +
      letters[Math.floor(Math.random() * 26)] +
      digits[Math.floor(Math.random() * 10)] +
      digits[Math.floor(Math.random() * 10)];
  }

  // Start a new session
  document.getElementById("startBtn").onclick = async () => {
    const newCode = generateCode();
    const sessionRef = doc(db, "sessions", newCode);
    await setDoc(sessionRef, {
      active: true,
      createdAt: new Date().toISOString(),
      groups: 1,
      moderator: "admin"
    });
    currentSession = newCode;
    sessionInfo.innerHTML = `Session Started: <strong>${newCode}</strong>`;
    loadQueue(newCode);
  };

  // Load an existing session
  document.getElementById("loadBtn").onclick = () => {
    const code = document.getElementById("sessionCode").value.trim();
    if (!code) return alert("Enter session code");
    currentSession = code;
    sessionInfo.innerHTML = `Loaded Session: <strong>${code}</strong>`;
    loadQueue(code);
  };

  // Listen to queue updates
  function loadQueue(code) {
    if (unsub) unsub();
    const qRef = collection(db, "sessions", code, "queue");
    unsub = onSnapshot(qRef, (snap) => {
      queueList.innerHTML = "";
      const members = [];
      snap.forEach((d) => members.push({ ...d.data(), id: d.id }));
      members.sort((a, b) => a.joinTime - b.joinTime);

      members.forEach((m) => {
        const card = document.createElement("div");
        card.className = "queue-card";
        card.innerHTML = `
          <b>${m.name}</b> 
          ${m.hasSpoken ? "<span class='badge bg-secondary ms-2'>Spoken</span>" : ""}
          <div class='mt-2'>
            <button class='btn btn-sm btn-success me-2 mark-btn' data-id='${m.id}'>Mark Spoken</button>
            <button class='btn btn-sm btn-danger remove-btn' data-id='${m.id}'>Remove</button>
          </div>`;
        queueList.appendChild(card);
      });

      // Attach working click events AFTER rendering
      document.querySelectorAll(".mark-btn").forEach((btn) => {
        btn.onclick = () => markSpoken(code, btn.dataset.id, btn);
      });
      document.querySelectorAll(".remove-btn").forEach((btn) => {
        btn.onclick = () => removeUser(code, btn.dataset.id);
      });
    });
  }

  // Mark a user as spoken ‚úÖ
  async function markSpoken(session, id, btnEl) {
    const ref = doc(db, "sessions", session, "queue", id);
    await updateDoc(ref, { hasSpoken: true });
    btnEl.innerHTML = "‚úÖ Marked";
    btnEl.classList.remove("btn-success");
    btnEl.classList.add("btn-outline-secondary");
  }

  // Remove a user ‚ùå
  async function removeUser(session, id) {
    const ref = doc(db, "sessions", session, "queue", id);
    await deleteDoc(ref);
    alert("Removed from queue");
  }
</script>

</body>
</html>
